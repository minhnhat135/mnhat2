import requests
import re
import datetime
from bs4 import BeautifulSoup
from urllib.parse import urlparse, urlunparse
from telegram import Update, ParseMode, User
from telegram.ext import Updater, CommandHandler, CallbackContext

# --- Cáº¤U HÃŒNH ---
# Báº N PHáº¢I Tá»° THAY THáº¾ CÃC GIÃ TRá»Š DÆ¯á»šI ÄÃ‚Y
TELEGRAM_TOKEN = '8383293948:AAEDVbBV05dXWHNZXod3RRJjmwqc2N4xsjQ' 
ADMIN_ID = 5127429005 # Thay báº±ng ID admin cá»§a báº¡n náº¿u cáº§n

# Danh sÃ¡ch cÃ¡c cá»•ng thanh toÃ¡n vÃ  cÃ¡c tá»« khÃ³a nháº­n dáº¡ng
# PHIÃŠN Báº¢N Má»ž Rá»˜NG NHáº¤T
PAYMENT_GATEWAYS = {
    # === Cá»•ng thanh toÃ¡n quá»‘c táº¿ phá»• biáº¿n ===
    'PayPal': ['paypal.com', 'paypalobjects.com', 'paypal-sdk'],
    'Stripe': ['stripe.com', 'js.stripe.com', 'stripe-js', 'stripecdn.com', 'stripe.network'],
    'Adyen': ['adyen.com', 'checkout.adyen.com', 'js.adyen.com'],
    'Braintree': ['braintreegateway.com', 'js.braintreegateway.com', 'braintree-api'],
    'Square': ['squareup.com', 'js.squareup.com'],
    'Worldpay': ['worldpay.com', 'fisglobal.com', 'wp-ecommerce.com'],
    'Checkout.com': ['checkout.com', 'js.checkout.com'],
    '2Checkout (Verifone)': ['2checkout.com', '2monetize.com', 'verifone.com'],
    'Amazon Pay': ['amazon.com/pay', 'pay.amazon.com', 'payments.amazon.com'],
    'Skrill': ['skrill.com'],
    'Neteller': ['neteller.com'],
    'Payoneer': ['payoneer.com'],
    'dLocal': ['dlocal.com'],
    'Global Payments': ['globalpaymentsinc.com', 'globalpay.com'],
    
    # === VÃ­ Ä‘iá»‡n tá»­ & Ná»n táº£ng ===
    'Google Pay': ['pay.google.com', 'google-pay', 'googlepay'],
    'Apple Pay': ['apple-pay', 'ApplePay'],
    'Shopify Payments': ['Shopify.Payments', 'cdn.shopify.com/shopifycloud/payment-sheet'],

    # === Mua ngay, tráº£ sau (Buy Now, Pay Later) ===
    'Klarna': ['klarna.com', 'klarna.js', 'klarnacdn.net', 'sofort.com'],
    'Afterpay / Clearpay': ['afterpay.com', 'clearpay.co.uk'],
    'Affirm': ['affirm.com'],
    'Atome': ['atome.sg', 'atome.my', 'atome.id'],

    # === Cá»•ng thanh toÃ¡n khu vá»±c ChÃ¢u Má»¹ ===
    'Authorize.Net': ['authorize.net', 'jstest.authorize.net', 'accept.authorize.net'],
    'Moneris': ['moneris.com'],
    'WePay (Chase)': ['wepay.com'],
    'Mercado Pago': ['mercadopago.com', 'mercadopago.com.br', 'mercadolibre.com'],
    'PagSeguro (PagBank)': ['pagseguro.uol.com.br', 'pagseguro.com.br'],
    'Cielo': ['cielo.com.br'],
    'Ebanx': ['ebanx.com'],
    
    # === Cá»•ng thanh toÃ¡n khu vá»±c ChÃ¢u Ã‚u ===
    'Mollie': ['mollie.com', 'mollie.nl'],
    'Sage Pay (Opayo)': ['sagepay.com', 'opayo.co.uk'],
    'Trustly': ['trustly.com'],
    'iDEAL': ['ideal-payment', 'ideal.nl'],
    'Bancontact': ['bancontact.com', 'bancontact.be'],
    'Giropay': ['giropay.de'],
    'Przelewy24 (P24)': ['przelewy24.pl'],
    'SecurionPay': ['securionpay.com'],
    'GoCardless': ['gocardless.com'],
    'YooKassa (Yandex)': ['yookassa.ru', 'kassa.yandex.ru'],

    # === Cá»•ng thanh toÃ¡n khu vá»±c ChÃ¢u Ã & ThÃ¡i BÃ¬nh DÆ°Æ¡ng ===
    'Alipay': ['alipay.com', 'alipayobjects.com'],
    'WeChat Pay': ['pay.weixin.qq.com'],
    'Razorpay': ['razorpay.com', 'checkout.razorpay.com'],
    'Paytm': ['paytm.com', 'paytm.in'],
    'CCAvenue': ['ccavenue.com'],
    'PayU': ['payu.com', 'payu.in', 'payulatam.com'],
    'eGHL': ['e-ghl.com', 'ghl.com'],
    'Omise': ['omise.co'],
    'eWAY': ['eway.io', 'eway.com.au'],
    'POLi': ['polipayments.com'],
    'Dragonpay': ['dragonpay.ph'],
    'PayTabs': ['paytabs.com'],
    'GrabPay': ['grab.com/pay'],
    'GoPay': ['gopay.co.id'],
    'VnPay': ['vnpay.vn', 'sandbox.vnpayment.vn', 'vnpayment.vn'],
    'MoMo': ['momo.vn', 'sdk.momo.vn'],
    'ZaloPay': ['zalopay.vn', 'sbgateway.zalopay.vn'],

    # === Cá»•ng thanh toÃ¡n khu vá»±c ChÃ¢u Phi ===
    'Paystack': ['paystack.com', 'js.paystack.co'],
    'Flutterwave': ['flutterwave.com', 'ravepay.co', 'rave.flutterwave.com'],

    # === Cá»•ng thanh toÃ¡n tiá»n mÃ£ hÃ³a ===
    'Coinbase Commerce': ['commerce.coinbase.com'],
    'BitPay': ['bitpay.com'],
    'CoinPayments': ['coinpayments.net'],

    # === Cá»•ng thanh toÃ¡n rá»§i ro cao (High-risk) / Niche ===
    'CCBill': ['ccbill.com'],
    'Paxum': ['paxum.com'],
}

# --- CÃC HÃ€M LOGIC ---

def normalize_url(url: str) -> str:
    """Chuáº©n hÃ³a URL Ä‘á»ƒ Ä‘áº£m báº£o cÃ³ scheme (http/https)"""
    if not re.match(r'^[a-zA-Z0-9]+://', url):
        url = 'https://' + url
    
    parsed_url = urlparse(url)
    clean_url = urlunparse((parsed_url.scheme, parsed_url.netloc, '/', '', '', ''))
    return clean_url

def check_website(url: str) -> dict:
    results = {
        'site': None,
        'gateways': set(),
        'cloudflare': False,
        'captcha': False,
        'error': None
    }
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
        'Accept-Language': 'en-US,en;q=0.9',
        'Accept-Encoding': 'gzip, deflate, br',
    }
    try:
        normalized_url = normalize_url(url)
        results['site'] = urlparse(normalized_url).netloc
        response = requests.get(normalized_url, headers=headers, timeout=15, allow_redirects=True)
        response.raise_for_status()
        content = response.text.lower()
        if 'cloudflare' in response.headers.get('Server', '').lower() or 'cf-ray' in response.headers:
            results['cloudflare'] = True
        soup = BeautifulSoup(content, 'html.parser')
        page_text_and_scripts = ' '.join(str(s) for s in soup.find_all(['script', 'body']))
        for gateway, keywords in PAYMENT_GATEWAYS.items():
            for keyword in keywords:
                if keyword.lower() in page_text_and_scripts:
                    results['gateways'].add(gateway)
        captcha_keywords = ['recaptcha', 'hcaptcha', 'captcha', 'turnstile', 'geetest']
        for keyword in captcha_keywords:
            if keyword in page_text_and_scripts:
                results['captcha'] = True
                break
    except requests.exceptions.Timeout:
        results['error'] = "Lá»—i: YÃªu cáº§u háº¿t thá»i gian chá»."
    except requests.exceptions.TooManyRedirects:
        results['error'] = "Lá»—i: Trang web cÃ³ quÃ¡ nhiá»u láº§n chuyá»ƒn hÆ°á»›ng."
    except requests.exceptions.RequestException:
        results['error'] = "Lá»—i káº¿t ná»‘i: KhÃ´ng thá»ƒ truy cáº­p trang web. HÃ£y cháº¯c cháº¯n URL chÃ­nh xÃ¡c."
    except Exception as e:
        results['error'] = f"ÄÃ£ xáº£y ra lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh: {e}"
    return results

# --- CÃC HÃ€M Xá»¬ LÃ Lá»†NH TELEGRAM ---

def start(update: Update, context: CallbackContext) -> None:
    user = update.effective_user
    update.message.reply_html(
        rf"ChÃ o {user.mention_html()}!",
        reply_to_message_id=update.message.message_id
    )
    update.message.reply_text(
        "TÃ´i lÃ  Bot tra cá»©u Gateway! Gá»­i cho tÃ´i má»™t lá»‡nh vá»›i cÃº phÃ¡p:\n\n"
        "`/check example.com`\n\n"
        "Ä‘á»ƒ báº¯t Ä‘áº§u.",
        parse_mode=ParseMode.MARKDOWN
    )

def check_command(update: Update, context: CallbackContext) -> None:
    if not context.args:
        update.message.reply_text("Vui lÃ²ng nháº­p URL cá»§a trang web. \nVÃ­ dá»¥: `/check raisenow.com`", parse_mode=ParseMode.MARKDOWN)
        return
    url = context.args[0]
    user_info = update.message.from_user
    msg = update.message.reply_text("ðŸ”Ž Äang náº¡p thÃ´ng tin, vui lÃ²ng chá»...")
    start_time = datetime.datetime.now()
    data = check_website(url)
    end_time = datetime.datetime.now()
    time_taken = (end_time - start_time).total_seconds()
    if data['error']:
        text_response = f"âŒ *Lá»—i*\n`{data['error']}`"
        context.bot.edit_message_text(
            chat_id=update.message.chat_id,
            message_id=msg.message_id,
            text=text_response,
            parse_mode=ParseMode.MARKDOWN
        )
        return
    gateways_str = ", ".join(sorted(list(data['gateways']))) if data['gateways'] else "KhÃ´ng tÃ¬m tháº¥y"
    captcha_icon = "ðŸš«" if data['captcha'] else "âœ…"
    cloudflare_icon = "âœ…" if data['cloudflare'] else "âŒ"
    text_response = (
        f"âœ… *Information fetched*\n\n"
        f"Site âž `{data['site']}`\n"
        f"Gateways âž `{gateways_str}`\n"
        f"Security âž Captcha : {captcha_icon} | Cloudflare : {cloudflare_icon}\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"ðŸ’Ž *Time Taken* : `{time_taken:.2f}s`\n"
        f"ðŸ’Ž *Checked by* {user_info.mention_html()} [Free]\n"
        f"ðŸ’Ž *Bot Gateway Lookup V3*\n"
    )
    context.bot.edit_message_text(
        chat_id=update.message.chat_id,
        message_id=msg.message_id,
        text=text_response,
        parse_mode=ParseMode.HTML
    )

def main() -> None:
    updater = Updater(TELEGRAM_TOKEN, use_context=True)
    dispatcher = updater.dispatcher
    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("check", check_command))
    dispatcher.add_handler(CommandHandler("bh", check_command))
    updater.start_polling()
    print("Bot Ä‘Ã£ khá»Ÿi Ä‘á»™ng vÃ  Ä‘ang cháº¡y...")
    updater.idle()

if __name__ == '__main__':
    main()
